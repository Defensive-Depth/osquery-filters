WITH proc_filtering (rule_target,rule_logic,rule_content) AS (VALUES (1,1,' "C:\Windows\system32\wermgr.exe" "-queuereporting_svc" '),(1,1,'C:\Windows\system32\DllHost.exe /Processid'),(1,1,'C:\Windows\system32\wbem\wmiprvse.exe -Embedding'),(1,1,'C:\Windows\system32\wbem\wmiprvse.exe -secured -Embedding'),(1,2,'C:\Windows\system32\wermgr.exe -upload'),(1,2,'C:\Windows\system32\SearchIndexer.exe /Embedding'),(1,2,'C:\windows\system32\wermgr.exe -queuereporting'),(1,2,'\??\C:\Windows\system32\autochk.exe *'),(1,2,'\SystemRoot\System32\smss.exe'),(1,2,'C:\Windows\System32\RuntimeBroker.exe -Embedding'),(1,2,'C:\WINDOWS\system32\devicecensus.exe UserCxt'),(1,2,'C:\Windows\System32\usocoreworker.exe -Embedding'),(1,2,'C:\Windows\system32\svchost.exe -k appmodel -s StateRepository'),(1,2,'C:\Windows\system32\svchost.exe -k appmodel -p -s camsvc'),(1,2,'C:\Windows\system32\svchost.exe -k appmodel'),(1,2,'C:\Windows\system32\svchost.exe -k appmodel -p -s tiledatamodelsvc'),(1,2,'C:\Windows\system32\svchost.exe -k camera -s FrameServer'),(1,2,'C:\Windows\system32\svchost.exe -k dcomlaunch -s LSM'),(1,2,'C:\Windows\system32\svchost.exe -k dcomlaunch -s PlugPlay'),(1,2,'C:\Windows\system32\svchost.exe -k defragsvc'),(1,2,'C:\Windows\system32\svchost.exe -k devicesflow -s DevicesFlowUserSvc'),(1,2,'C:\Windows\system32\svchost.exe -k imgsvc'),(1,2,'C:\Windows\system32\svchost.exe -k localService -s EventSystem'),(1,2,'C:\Windows\system32\svchost.exe -k localService -s bthserv'),(1,2,'C:\Windows\system32\svchost.exe -k LocalService -p -s BthAvctpSvc'),(1,2,'C:\Windows\system32\svchost.exe -k localService -s nsi'),(1,2,'C:\Windows\system32\svchost.exe -k localService -s w32Time'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceAndNoImpersonation'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceAndNoImpersonation -p'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNetworkRestricted -s Dhcp'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNetworkRestricted -s EventLog'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNetworkRestricted -s TimeBrokerSvc'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNetworkRestricted -s WFDSConMgrSvc'),(1,2,'C:\Windows\system32\svchost.exe -k LocalServiceNetworkRestricted -s BTAGService'),(1,2,'C:\Windows\System32\svchost.exe -k LocalSystemNetworkRestricted -p -s NcbService'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNetworkRestricted'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceAndNoImpersonation -s SensrSvc'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceAndNoImpersonation -p -s SSDPSRV'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNoNetwork'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -p -s WPDBusEnum'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -p -s fhsvc'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s DeviceAssociationService'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s NcbService'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s SensorService'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s TabletInputService'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s UmRdpService'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s WPDBusEnum'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -p -s NgcSvc'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceNetworkRestricted -p -s NgcCtnrSvc'),(1,2,'C:\Windows\system32\svchost.exe -k localServiceAndNoImpersonation -s SCardSvr'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -p -s wuauserv'),(1,2,'C:\Windows\System32\svchost.exe -k netsvcs -p -s SessionEnv'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted -s WdiSystemHost'),(1,2,'C:\Windows\System32\svchost.exe -k localSystemNetworkRestricted -p -s WdiSystemHost'),(1,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -p -s wlidsvc'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -p -s ncaSvc'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s BDESVC'),(1,2,'C:\Windows\System32\svchost.exe -k netsvcs -p -s BDESVC'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -p -s BITS'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s BITS'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s CertPropSvc'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s DsmSvc'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -p -s Appinfo'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s Gpsvc'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s ProfSvc'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s SENS'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s SessionEnv'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s Themes'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs -s Winmgmt'),(1,2,'C:\Windows\system32\svchost.exe -k netsvcs'),(1,2,'C:\Windows\system32\svchost.exe -k networkService -p -s DoSvc'),(1,2,'C:\Windows\system32\svchost.exe -k networkService -s Dnscache'),(1,2,'C:\Windows\system32\svchost.exe -k networkService -s LanmanWorkstation'),(1,2,'C:\Windows\system32\svchost.exe -k networkService -s NlaSvc'),(1,2,'C:\Windows\system32\svchost.exe -k networkService -s TermService'),(1,2,'C:\Windows\system32\svchost.exe -k networkService'),(1,2,'C:\Windows\system32\svchost.exe -k networkService -p'),(1,2,'C:\Windows\system32\svchost.exe -k networkServiceNetworkRestricted'),(1,2,'C:\Windows\system32\svchost.exe -k rPCSS'),(1,2,'C:\Windows\system32\svchost.exe -k secsvcs'),(1,2,'C:\Windows\system32\svchost.exe -k swprv'),(1,2,'C:\Windows\system32\svchost.exe -k unistackSvcGroup'),(1,2,'C:\Windows\system32\svchost.exe -k utcsvc'),(1,2,'C:\Windows\system32\svchost.exe -k wbioSvcGroup'),(1,2,'C:\Windows\system32\svchost.exe -k werSvcGroup'),(1,2,'C:\Windows\system32\svchost.exe -k wusvcs -p -s WaaSMedicSvc'),(1,2,'C:\Windows\System32\svchost.exe -k wsappx -p -s ClipSVC'),(1,2,'C:\Windows\system32\svchost.exe -k wsappx -p -s AppXSvc'),(1,2,'C:\Windows\system32\svchost.exe -k wsappx -s ClipSVC'),(1,2,'C:\Windows\system32\svchost.exe -k wsappx'),(1,2,'C:\Windows\system32\deviceenroller.exe /c /AutoEnrollMDM'),(1,1,'"C:\Program Files (x86)\Microsoft\Edge Dev\Application\msedge.exe" --type='),(1,1,'C:\Windows\Microsoft.NET\Framework\v4.0.30319\ngen.exe'),(1,1,'C:\WINDOWS\Microsoft.NET\Framework64\v4.0.30319\Ngen.exe'),(1,1,'C:\Windows\Microsoft.NET\Framework\v4.0.30319\ngentask.exe'),(1,1,'C:\WINDOWS\Microsoft.NET\Framework64\v4.0.30319\ngentask.exe'),(1,1,'"C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --type='),(1,1,'"C:\Program Files\Google\Chrome\Application\chrome.exe" --type='),(2,2,'C:\Program Files (x86)\Common Files\microsoft shared\ink\TabTip32.exe'),(2,2,'C:\Windows\System32\TokenBrokerCookies.exe'),(2,2,'C:\Windows\System32\plasrv.exe'),(2,2,'C:\Windows\System32\wifitask.exe'),(2,2,'C:\Windows\system32\CompatTelRunner.exe'),(2,2,'C:\Windows\system32\PrintIsolationHost.exe'),(2,2,'C:\Windows\system32\SppExtComObj.Exe'),(2,2,'C:\Windows\system32\audiodg.exe'),(2,2,'C:\Windows\system32\conhost.exe'),(2,2,'C:\Windows\system32\mobsync.exe'),(2,2,'C:\Windows\system32\musNotification.exe'),(2,2,'C:\Windows\system32\musNotificationUx.exe'),(2,2,'C:\Windows\system32\powercfg.exe'),(2,2,'C:\Windows\system32\sndVol.exe'),(2,2,'C:\Windows\system32\sppsvc.exe'),(2,2,'C:\Windows\system32\wbem\WmiApSrv.exe'),(2,2,'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\mscorsvw.exe'),(2,2,'C:\Windows\Microsoft.NET\Framework\v4.0.30319\mscorsvw.exe'),(2,2,'C:\Windows\Microsoft.Net\Framework64\v3.0\WPF\PresentationFontCache.exe'),(2,2,'C:\Program Files\Microsoft Office\Office16\MSOSYNC.EXE'),(2,2,'C:\Program Files (x86)\Microsoft Office\Office16\MSOSYNC.EXE'),(2,2,'C:\Program Files\Common Files\Microsoft Shared\OfficeSoftwareProtectionPlatform\OSPPSVC.EXE'),(2,2,'C:\Program Files\Microsoft Office\Office16\msoia.exe'),(2,2,'C:\Program Files (x86)\Microsoft Office\root\Office16\officebackgroundtaskhandler.exe'),(2,2,'C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeC2RClient.exe'),(2,2,'C:\Program Files\Windows Media Player\wmpnscfg.exe'),(4,2,'C:\Windows\system32\SearchIndexer.exe'),(4,2,'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\mscorsvw.exe'),(4,2,'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\ngentask.exe'),(4,2,'C:\Windows\Microsoft.NET\Framework\v4.0.30319\mscorsvw.exe'),(4,2,'C:\Windows\Microsoft.NET\Framework\v4.0.30319\ngentask.exe'),(4,2,'C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeClickToRun.exe'),(4,2,'C:\Program Files\Common Files\Microsoft Shared\ClickToRun\OfficeC2RClient.exe'),(3,1,'%%SystemRoot%%\system32\csrss.exe ObjectDirectory=\Windows'),(3,2,'C:\windows\system32\wermgr.exe -queuereporting'),(3,2,'C:\Windows\system32\svchost.exe -k netsvcs'),(3,2,'C:\Windows\system32\svchost.exe -k localSystemNetworkRestricted'),(3,1,'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\ngentask.exe')),
-- Remove Exact Match Paths
first_pass AS (
SELECT p.* FROM processes p
LEFT JOIN proc_filtering pf
ON (LOWER(p.path) = LOWER(pf.rule_content) AND pf.rule_target = 2 AND pf.rule_logic = 2)
WHERE pf.rule_content IS NULL),

-- Remove Exact Match CmdLines
second_pass AS (
SELECT fp.* FROM first_pass fp
LEFT JOIN proc_filtering pf
ON (LOWER(fp.cmdline) = LOWER(pf.rule_content) AND pf.rule_target = 1 AND pf.rule_logic = 2)
WHERE pf.rule_content IS NULL),

-- Remove CmdLines that Begin With...
third_pass AS (
SELECT sp.* FROM second_pass sp 
LEFT JOIN proc_filtering pf 
ON (sp.cmdline LIKE CONCAT(pf.rule_content,'%') 
	AND pf.rule_target = 1 AND pf.rule_logic = 1) 
WHERE pf.rule_content IS NULL),

-- Collect Parent process data
parent_processes AS (
SELECT tp.*, p.cmdline AS parent_cmdline, p.path AS parent_path FROM third_pass tp LEFT JOIN processes p ON tp.parent = p.pid),

-- Remove Exact Match Path Parent Processes
fourth_pass AS (
SELECT p.* FROM parent_processes p
LEFT JOIN proc_filtering pf
ON (LOWER(p.parent_path) = LOWER(pf.rule_content) AND pf.rule_target = 4 AND pf.rule_logic = 2)
WHERE pf.rule_content IS NULL),

-- Remove Exact Match Path Parent Cmdline
fifth_pass AS (
SELECT fps.* FROM fourth_pass fps
LEFT JOIN proc_filtering pf
ON (LOWER(fps.parent_cmdline) = LOWER(pf.rule_content) AND pf.rule_target = 3 AND pf.rule_logic = 2)
WHERE pf.rule_content IS NULL),

-- Remove Parent Cmdlines that begin with
sixth_pass AS (
SELECT fifp.* FROM fifth_pass fifp 
LEFT JOIN proc_filtering pf 
ON (fifp.cmdline LIKE CONCAT(pf.rule_content,'%') 
	AND pf.rule_target = 3 AND pf.rule_logic = 1) 
WHERE pf.rule_content IS NULL)

SELECT * FROM sixth_pass;